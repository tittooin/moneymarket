async function fetchNewsJSON(url){try{const res=await fetch(url,{cache:'no-cache'});if(!res.ok)throw new Error('HTTP '+res.status);return await res.json()}catch(e){console.error('News fetch error',e);return null}}
async function fetchLatestBlogRoundup(){try{const res=await fetch('/blog/index.html',{cache:'no-cache'});if(!res.ok)return null;const html=await res.text();const tmp=document.createElement('div');tmp.innerHTML=html;const links=Array.from(tmp.querySelectorAll('a')).map(a=>a.getAttribute('href')||'').filter(h=>/\/blog\/posts\/daily-finance-roundup-/.test(h));if(!links.length)return null;links.sort(function(a,b){return a<b?1:-1});return links[0]}catch(e){return null}}
function renderMarquee(items,container,speed){const ordered=items.slice().sort(function(a,b){var po=(b.orig_slug?1:0)-(a.orig_slug?1:0);if(po!==0)return po;return (b.image?1:0)-(a.image?1:0)});const wrap=document.createElement('div');wrap.className='marquee';const track=document.createElement('div');track.className='track';wrap.appendChild(track);function addSet(){ordered.forEach(function(it){const to=(it.orig_slug?('/news/originals/'+it.orig_slug+'.html'):(it.slug?('/news/articles/'+it.slug+'.html'):'/news/index.html'));const a=document.createElement('a');a.className='marq-item';a.href=to;a.textContent=it.title;track.appendChild(a)})}addSet();addSet();container.innerHTML='';if(speed){track.style.setProperty('--dur',String(speed)+'s')}container.appendChild(wrap)}
function renderNews(items,container,limit,analysisURL){const list=document.createElement('div');const ordered=items.slice().sort(function(a,b){var po=(b.orig_slug?1:0)-(a.orig_slug?1:0);if(po!==0)return po;return (b.image?1:0)-(a.image?1:0)});ordered.slice(0,limit).forEach(function(it){const to=(it.orig_slug?('/news/originals/'+it.orig_slug+'.html'):(it.slug?('/news/articles/'+it.slug+'.html'):'/news/index.html'));const card=document.createElement('a');card.className='card clickable';card.href=to;card.addEventListener('click',function(ev){ev.preventDefault();window.location.assign(to)});card.addEventListener('pointerdown',function(ev){if(ev.button===0){try{ev.preventDefault();window.location.assign(to)}catch(_){}}});if(it.image){const img=document.createElement('img');img.className='thumb';img.src=String(it.image||'').replace(/`/g,'').trim();img.alt=it.title||'';img.loading='lazy';img.onerror=function(){try{img.remove()}catch(e){}};card.appendChild(img)}const title=document.createElement('div');title.textContent=it.title;card.appendChild(title);const p=document.createElement('p');p.textContent=(it.source?it.source+' â€¢ ':'')+(it.pubDate?new Date(it.pubDate).toLocaleString('en-IN'):'');card.appendChild(p);list.appendChild(card)});container.innerHTML='';if(analysisURL){const row=document.createElement('div');row.className='cta-row';const al=document.createElement('a');al.className='button ghost';al.href=analysisURL;al.textContent='Read latest analysis';row.appendChild(al);container.appendChild(row)}container.appendChild(list)}
function getPageParam(){try{const u=new URL(location.href);const p=parseInt(u.searchParams.get('page')||'1',10);return isNaN(p)||p<1?1:p}catch(e){return 1}}
function renderPagination(container,page,totalPages){const nav=document.createElement('div');nav.className='cta-row';const prev=document.createElement('a');prev.className='button ghost';prev.textContent='Prev';prev.href='?page='+(page-1);if(page<=1){prev.style.pointerEvents='none';prev.style.opacity='0.5'}const next=document.createElement('a');next.className='button';next.textContent='Next';next.href='?page='+(page+1);if(page>=totalPages){next.style.pointerEvents='none';next.style.opacity='0.5'}nav.appendChild(prev);nav.appendChild(next);container.appendChild(nav)}
function renderNewsIndex(items,container,perPage){const page=getPageParam();const total=items.length;const totalPages=Math.max(1,Math.ceil(total/perPage));const start=(page-1)*perPage;const end=Math.min(total,start+perPage);const slice=items.slice(start,end);renderNews(slice,container,perPage);renderPagination(container,page,totalPages)}
async function initNewsWidgets(){const widgets=document.querySelectorAll('.news-widget');if(!widgets.length)return;const data=await fetchNewsJSON('/assets/data/news.json');if(!data||!data.items||!data.items.length){widgets.forEach(w=>{w.innerHTML='<div class="card no-click"><p>News unavailable. Add feeds in scripts/fetch_news.py and run the updater.</p></div>'});return}const analysisURL=await fetchLatestBlogRoundup();widgets.forEach(w=>{const limit=parseInt(w.getAttribute('data-limit')||'6',10);renderNews(data.items,w,limit,analysisURL);w.addEventListener('click',function(ev){const el=ev.target.closest('a.card, .card.clickable');if(!el)return;const linkEl=(el.tagName==='A')?el:(el.querySelector('a[href]'));const href=linkEl?(linkEl.getAttribute('href')||linkEl.href):null;if(!href)return;ev.preventDefault();window.location.href=href});if(analysisURL){const outer=w.closest('.card');if(outer){outer.addEventListener('click',function(ev){const insideAnchor=ev.target.closest('a[href]');const insideNews=ev.target.closest('a.card');if(insideAnchor||insideNews)return;window.location.href=analysisURL})}}})}
document.addEventListener('DOMContentLoaded',initNewsWidgets);
document.addEventListener('DOMContentLoaded',async function(){const mqs=document.querySelectorAll('.news-marquee');if(!mqs.length)return;const data=await fetchNewsJSON('/assets/data/news.json');if(!data||!data.items||!data.items.length){mqs.forEach(function(m){m.innerHTML='<div class="card no-click"><p>News unavailable. Add feeds in scripts/fetch_news.py and run the updater.</p></div>'});return}mqs.forEach(function(m){var sp=parseInt(m.getAttribute('data-speed')||'40',10);renderMarquee(data.items,m,sp)})});
document.addEventListener('click',function(e){var el=e.target&&e.target.closest&&e.target.closest('a.card, .card.clickable');if(!el)return;var linkEl=(el.tagName==='A')?el:(el.querySelector('a[href]'));var href=linkEl?(linkEl.getAttribute('href')||linkEl.href):null;if(!href)return;e.preventDefault();try{location.href=href}catch(err){}});
document.addEventListener('DOMContentLoaded',async function(){const idx=document.querySelector('.news-index');if(!idx)return;const data=await fetchNewsJSON('/assets/data/news.json');if(!data||!data.items||!data.items.length){idx.innerHTML='<div class="card no-click"><p>News unavailable. Please check feeds.</p></div>';return}renderNewsIndex(data.items,idx,24)});
