async function fetchNewsJSON(url){try{const res=await fetch(url,{cache:'no-cache'});if(!res.ok)throw new Error('HTTP '+res.status);return await res.json()}catch(e){console.error('News fetch error',e);return null}}
function renderNews(items,container,limit){const list=document.createElement('div');const ordered=items.slice().sort(function(a,b){var po=(b.orig_slug?1:0)-(a.orig_slug?1:0);if(po!==0)return po;return (b.image?1:0)-(a.image?1:0)});ordered.slice(0,limit).forEach(function(it){const card=document.createElement('div');card.className='card clickable';if(it.image){const img=document.createElement('img');img.className='thumb';img.src=it.image;img.alt=it.title||'';img.loading='lazy';img.onerror=function(){try{img.remove()}catch(e){}};card.appendChild(img)}const to=(it.orig_slug?('/news/originals/'+it.orig_slug+'.html'):(it.slug?('/news/articles/'+it.slug+'.html'):it.link));const a=document.createElement('a');a.href=to;a.textContent=it.title;const p=document.createElement('p');p.textContent=(it.source?it.source+' â€¢ ':'')+(it.pubDate?new Date(it.pubDate).toLocaleString('en-IN'):'');card.appendChild(a);card.appendChild(p);card.addEventListener('click',function(){location.href=to});list.appendChild(card)});container.innerHTML='';container.appendChild(list)}
function getPageParam(){try{const u=new URL(location.href);const p=parseInt(u.searchParams.get('page')||'1',10);return isNaN(p)||p<1?1:p}catch(e){return 1}}
function renderPagination(container,page,totalPages){const nav=document.createElement('div');nav.className='cta-row';const prev=document.createElement('a');prev.className='button ghost';prev.textContent='Prev';prev.href='?page='+(page-1);if(page<=1){prev.style.pointerEvents='none';prev.style.opacity='0.5'}const next=document.createElement('a');next.className='button';next.textContent='Next';next.href='?page='+(page+1);if(page>=totalPages){next.style.pointerEvents='none';next.style.opacity='0.5'}nav.appendChild(prev);nav.appendChild(next);container.appendChild(nav)}
function renderNewsIndex(items,container,perPage){const page=getPageParam();const total=items.length;const totalPages=Math.max(1,Math.ceil(total/perPage));const start=(page-1)*perPage;const end=Math.min(total,start+perPage);const slice=items.slice(start,end);renderNews(slice,container,perPage);renderPagination(container,page,totalPages)}
async function initNewsWidgets(){const widgets=document.querySelectorAll('.news-widget');if(!widgets.length)return;const data=await fetchNewsJSON('/assets/data/news.json');if(!data||!data.items||!data.items.length){widgets.forEach(w=>{w.innerHTML='<div class="card no-click"><p>News unavailable. Add feeds in scripts/fetch_news.py and run the updater.</p></div>'});return}widgets.forEach(w=>{const limit=parseInt(w.getAttribute('data-limit')||'6',10);renderNews(data.items,w,limit)})}
document.addEventListener('DOMContentLoaded',initNewsWidgets);
document.addEventListener('DOMContentLoaded',async function(){const idx=document.querySelector('.news-index');if(!idx)return;const data=await fetchNewsJSON('/assets/data/news.json');if(!data||!data.items||!data.items.length){idx.innerHTML='<div class="card no-click"><p>News unavailable. Please check feeds.</p></div>';return}renderNewsIndex(data.items,idx,24)});
